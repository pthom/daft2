<!doctype html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Daft2 Example</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
            color: #333;
        }
        .emscripten {
            position: absolute;
            top: 0;
            left: 0;
            margin: 0;
            border: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            display: block;
            image-rendering: optimizeSpeed;
            image-rendering: -moz-crisp-edges;
            image-rendering: -o-crisp-edges;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: optimize-contrast;
            image-rendering: crisp-edges;
            image-rendering: pixelated;
            -ms-interpolation-mode: nearest-neighbor
        }
    </style>

    <script src="pyodide.js"></script>
</head>


<body>
    <script type="text/javascript">


        // WEBGGL2 or WEBGL1: it works with WebGL1 but not WebGL2...
        USE_WEBGL2 = true;

        python_code = `
import daft2

async def main():
    daft2.hello()

main()          
        `

        function logWebGLRendererInfo(context) {
            if (context.getExtension('WEBGL_debug_renderer_info')) {
                var debugInfo = context.getExtension('WEBGL_debug_renderer_info');
                console.log('Renderer:', context.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL));
                console.log('Vendor:', context.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL));
            } else {
                console.log('WEBGL_debug_renderer_info is not supported');
            }
        }

        function logWebGLShaderPrecisionFormat(context) {
            if (context.getExtension('WEBGL_debug_shaders')) {
                var vertShader = context.createShader(context.VERTEX_SHADER);
                context.shaderSource(vertShader, 'attribute vec2 position; void main() { gl_Position = vec4(position, 0.0, 1.0); }');
                context.compileShader(vertShader);
                console.log('Vertex Shader Debug Info:', context.getExtension('WEBGL_debug_shaders').getTranslatedShaderSource(vertShader));
            } else {
                console.log('WEBGL_debug_shaders is not supported');
            }
        }

        function get_webgl2_canvas() 
        {
            var canvasElement = document.getElementById("canvas");
        
            // Event listener for WebGL context loss
            canvasElement.addEventListener("webglcontextlost", function(event) 
                {
                    alert("WebGL context lost, please reload the page");
                    event.preventDefault();
                }, 
                false);
            
            if (typeof WebGL2RenderingContext !== 'undefined') 
            {
                var contextAttributes = {
                    stencil: true,
                    depth: true,
                    antialias: true,
                    preserveDrawingBuffer: false  // Typically false unless you need to preserve the buffer across frames
                };

                // WEBGGL2 or WEBGL1: it works with WebGL1 but not WebGL2...
                if (USE_WEBGL2)
                    var context = canvasElement.getContext("webgl2", contextAttributes);
                else
                    var context = canvasElement.getContext("webgl", contextAttributes);

                if (!context) 
                {
                    console.error("WebGL 2 not available, falling back to WebGL");
                    context = canvasElement.getContext("webgl", { stencil: true });
                    if (!context) 
                    {
                        alert("WebGL not available with stencil buffer");
                    }
                    else
                    {
                        console.log("WebGL 2 context without stencil created")
                    }
                }
                else
                {
                    console.log("WebGL 2 context with stencil created")
                }                

                console.log("context.getSupportedExtensions(): " + context.getSupportedExtensions());
                logWebGLRendererInfo(context);
                logWebGLShaderPrecisionFormat(context);
                
                return canvasElement;
            } 
            else 
            {
                alert("WebGL 2 not supported by this browser");
            }
        }

        async function main()
        {
            canvas = get_webgl2_canvas()

            let pyodide = await loadPyodide();
            // Temporary workaround for pyodide#3697
            pyodide._api._skip_unwind_fatal_error = true;

            await pyodide.loadPackage(["daft2"], { checkIntegrity: false })
            pyodide.canvas.setCanvas3D(canvas);  // setCanvas3D is an alias to setCanvas2D

            pyodide.runPythonAsync(python_code);
        }

        window.addEventListener('load', main)
    </script>


    <canvas class=emscripten id=canvas oncontextmenu=event.preventDefault() width="600" height="400"></canvas>
</body>
</html>